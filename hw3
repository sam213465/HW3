#include <iostream>
#include <fstream>
#include <string>
using namespace std;

struct Node {
  int r;
  int c;
  int dir;
  Node * next;
};

class Maze {
 private:
  int column;
  int row;
  char **grid;
 public:
  Maze(string filename) {
    ifstream fin(filename);
    if (!fin.is_open()) {
      cout << endl << filename << " does not exist!" << endl << endl;
    } else {
      fin >> column >> row;

      grid = new char*[row];
      for (int i = 0; i < row; i++) {
        grid[i] = new char[column];
      }
      for (int i = 0; i < row; i++) {
        for (int j = 0; j < column; j++) {
          fin >> grid[i][j];
        }
      }
    }
    fin.close();
  }

  ~Maze() {
    for (int i = 0; i < row; i++) {
      delete [] grid[i];
    }
    delete [] grid;
  }
  
  char Getgrid(int x, int y) {
  	return grid[x][y];
  }
  void Setgrid(int x, int y, char val) { 
    grid[x][y] = val; 
  }
  int Getrow() {
  	return row;
  }
  int Getcolumn() {
  	return column;
  }

  bool Inbounds(int x, int y) {
    if (x >= 0 && x < row && y >= 0 && y < column) {
      return true;
	}
	return false;
  }
  void Print(int row, int column) {
  	for (int i = 0; i < row; i++) {
  	  for (int j = 0; j < column; j++) {
  	  	cout << grid[i][j];
      }
	  cout << endl;
	}
  }
  
  void Copy(int row, int column) {
  	for (int i = 0; i < row; i++) {
  	  for (int j = 0; j < column; j++) {
  	  	if (grid[i][j] == 'V') {
  	      grid[i][j] = 'R';
		}
      }
	}
  }
};

class Stack {
 private:
  Node * top;
 public:
  Stack() {
    top = NULL;
  }
  ~Stack() {
    while (top) {
    Node *temp = top;
    top = top->next;
    delete temp;
    }
  }

  bool Isempty() {
    if (top == NULL) {
      return true;
    }
    return false;
  }

  void push(int r, int c, int d) {
    Node *newnode = new Node;
    newnode->r = r;
    newnode->c = c;
    newnode->dir = d;
    newnode->next = top;
    top = newnode;
  }

  bool pop(int &x, int &y, int &dir) {
    if (!top) return false;
    x = top->r;
    y = top->c;
    dir = top->dir;
    Node *temp = top;
    top = top->next;
    delete temp;
    return true;
  }
};
int dx[4] = {0, 1, 0, -1};  // 右 下 左 上
int dy[4] = {1, 0, -1, 0};

void Mission1(Maze &maze) {
    Stack path;
    int x = 0, y = 0;
    int dir = 0;  

    path.push(x, y, dir);
    maze.Setgrid(x, y, 'V');

    int curx, cury, curdir;

    while (!path.Isempty()) {
        path.pop(curx, cury, curdir);

       
        bool moved = false;
        for (int i = 0; i < 4; i++) {
            int nextdir = (curdir + i) % 4;  
            int nextx = curx + dx[nextdir];
            int nexty = cury + dy[nextdir];

            if (!maze.Inbounds(nextx, nexty)) continue;
            if (maze.Getgrid(nextx, nexty) == 'O' || maze.Getgrid(nextx, nexty) == 'V') continue;

       
            path.push(curx, cury, (nextdir + 1) % 4);  
            path.push(nextx, nexty, nextdir);

            if (maze.Getgrid(curx, cury) == 'G') {
              break;
			      }

            if (maze.Getgrid(nextx, nexty) != 'G') {
              maze.Setgrid(nextx, nexty, 'V');
			}

            moved = true;
            break;
        }

     
        if (maze.Getgrid(curx, cury) == 'G') {
            maze.Print(maze.Getrow(), maze.Getcolumn()); 
            maze.Copy(maze.Getrow(), maze.Getcolumn());  
            cout << endl;
            maze.Print(maze.Getrow(), maze.Getcolumn()); 
            return;
        }

        
        if (!moved) continue;
    }

    
    maze.Print(maze.Getrow(), maze.Getcolumn());
}

int main() {
  Maze *maze = nullptr;
  while (1) {
    cout << "*** (^_^) Data Structure (^o^) ***" << endl;
    cout << "*** Find the Goal(s) in a Maze ***" << endl;
    cout << "* 0. Quit                        *" << endl;
    cout << "* 1. Find one goal               *" << endl;
    cout << "* 2. Find goal(s) as requested   *" << endl;
    cout << "* 3. How many goals?             *" << endl;
    cout << "* 4. Shortest path to one goal   *" << endl;
    cout << "**********************************" << endl;
    string command;
    cout << "Input a command(0, 1, 2, 3, 4): ";
    cin >> command;
    cout << endl;
    if (command == "1") {
      int filenumber;
      cout << "Input a file number: ";
      cin >> filenumber;
      string filename = "input" + to_string(filenumber) + ".txt";
      if (maze != nullptr) delete maze;
        maze = new Maze(filename);
        Mission1(*maze);
    } else if (command == "2") {
      if (maze == nullptr) {
        cout << "### Execute command 1 to load a maze! ###" << endl;
        cout << endl;
	  } else {
        int goals;
        cout << "Number of G (goals):";
        cin >> goals;
        Mission2(*maze, goals);
      }
    } else if (command == "3") {
      if (maze == nullptr) {
        cout << "### Execute command 1 to load a maze! ###" << endl;
        cout << endl;
	  } else {
        Mission3(*maze);
      }
    } else if (command == "4") {
      int number;
      cout << "Input a file number: ";
      cin >> number;
      string filename = "input" + to_string(number) + ".txt";
      Maze * maze_mission4;
      maze_mission4 = new Maze(filename);
      if (maze_mission4 == nullptr) {
        cout << filename << " does not exist!" << endl;
        cout << endl;
      } else {
        Mission4(*maze_mission4);
      }
    } else if (command == "0") {
      break;
    } else {
      cout << "Command does not exist!" << endl;
      cout << endl;
    }
  }
  return 0;
}
